<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To-Do List</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        color: #333;
        display: flex;
      }

      .app-container {
        display: flex;
        width: 100%;
        height: 100vh;
      }

      /* Left Panel */
      .left-panel {
        width: 400px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .left-panel-header {
        padding: 30px 25px 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .left-panel-header h1 {
        font-size: 1.8em;
        font-weight: 700;
        color: #212529;
        margin-bottom: 5px;
      }

      .left-panel-header h1 .count {
        font-weight: 400;
        color: #6c757d;
        font-size: 0.7em;
      }

      .add-task-btn {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        background: #f0f0f0;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        color: #495057;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .add-task-btn:hover {
        background: #e0e0e0;
      }

      .todo-list {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        list-style: none;
      }

      .todo-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .todo-item:hover {
        background: #f8f9fa;
        border-color: #00d2ff;
      }

      .todo-item.selected {
        background: #e3f2fd;
        border-color: #00d2ff;
        border-width: 2px;
      }

      .todo-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #00d2ff;
      }

      .todo-item-content {
        flex: 1;
        min-width: 0;
      }

      .todo-title {
        font-size: 0.95em;
        font-weight: 500;
        color: #212529;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .todo-item.completed .todo-title {
        text-decoration: line-through;
        color: #adb5bd;
      }

      .todo-meta-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85em;
        color: #6c757d;
        flex-wrap: wrap;
      }

      .todo-due-date-badge {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .todo-subtasks-count {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .todo-tag {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 500;
      }

      .todo-tag.personal {
        background: #ffebee;
        color: #c62828;
      }

      .todo-tag.list {
        background: #fff9c4;
        color: #f57f17;
      }

      .todo-arrow {
        color: #adb5bd;
        font-size: 1.2em;
      }

      /* Right Panel */
      .right-panel {
        flex: 1;
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .right-panel-header {
        padding: 30px 40px;
        border-bottom: 1px solid #e0e0e0;
      }

      .right-panel-header h2 {
        font-size: 0.9em;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .right-panel-header .task-title {
        font-size: 1.8em;
        font-weight: 700;
        color: #212529;
      }

      .right-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 30px 40px;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .form-section label {
        display: block;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.9em;
      }

      textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
        resize: vertical;
      }

      textarea:focus {
        outline: none;
        border-color: #00d2ff;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      select,
      input[type="date"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95em;
        font-family: inherit;
        background: white;
        cursor: pointer;
      }

      select:focus,
      input[type="date"]:focus {
        outline: none;
        border-color: #00d2ff;
      }

      .tags-section {
        margin-top: 20px;
      }

      .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .tag {
        padding: 6px 12px;
        background: #80deea;
        color: white;
        border-radius: 16px;
        font-size: 0.85em;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .add-tag-btn {
        padding: 6px 12px;
        background: transparent;
        border: 1px dashed #adb5bd;
        border-radius: 16px;
        font-size: 0.85em;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .add-tag-btn:hover {
        border-color: #00d2ff;
        color: #00d2ff;
      }

      .subtasks-section {
        margin-top: 30px;
      }

      .subtasks-list {
        margin-top: 15px;
      }

      .subtask-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
      }

      .subtask-checkbox {
        width: 18px;
        height: 18px;
        accent-color: #00d2ff;
      }

      .subtask-text {
        flex: 1;
        font-size: 0.95em;
        color: #495057;
      }

      .add-subtask-btn {
        margin-top: 15px;
        padding: 10px;
        background: #f0f0f0;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        color: #495057;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
      }

      .add-subtask-btn:hover {
        background: #e0e0e0;
      }

      .right-panel-footer {
        padding: 20px 40px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }

      .btn-delete {
        padding: 12px 24px;
        background: #f0f0f0;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-delete:hover {
        background: #e0e0e0;
      }

      .btn-save {
        padding: 12px 24px;
        background: #ffc107;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-save:hover {
        background: #ffb300;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #adb5bd;
        text-align: center;
        padding: 40px;
      }

      .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state p {
        font-size: 1.1em;
      }

      .empty-right-panel {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #adb5bd;
        font-size: 1.1em;
      }

      /* Modal for adding new task */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-content h2 {
        margin-bottom: 20px;
        color: #212529;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn-cancel {
        background: #f0f0f0;
        color: #495057;
        flex: 1;
      }

      .btn-cancel:hover {
        background: #e0e0e0;
      }

      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95em;
        font-family: inherit;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #00d2ff;
      }

      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }

        .left-panel {
          width: 100%;
          height: 50vh;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Left Panel -->
      <div class="left-panel">
        <div class="left-panel-header">
          <h1>Today <span class="count" id="todo-count">0</span></h1>
          <button class="add-task-btn" onclick="openAddModal()">
            <span>+</span> Add New Task
          </button>
        </div>
        <ul id="todo-list" class="todo-list"></ul>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div id="right-panel-content">
          <div class="empty-right-panel">
            ÏûëÏóÖÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉà ÏûëÏóÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
          </div>
        </div>
      </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-modal" class="modal">
      <div class="modal-content">
        <h2>ÏÉà ÏûëÏóÖ Ï∂îÍ∞Ä</h2>
        <form id="add-task-form">
          <div class="form-section">
            <label for="new-title">Ï†úÎ™©</label>
            <input type="text" id="new-title" required />
          </div>
          <div class="form-section">
            <label for="new-description">ÏÑ§Î™Ö</label>
            <textarea id="new-description"></textarea>
          </div>
          <div class="form-row">
            <div class="form-section">
              <label for="new-list">List</label>
              <select id="new-list">
                <option value="Personal">Personal</option>
                <option value="Work">Work</option>
                <option value="List">List</option>
              </select>
            </div>
            <div class="form-section">
              <label for="new-due-date">Due date</label>
              <input type="date" id="new-due-date" />
            </div>
          </div>
          <div class="form-section">
            <label>Tags</label>
            <div class="tags-container" id="new-tags-container">
              <button type="button" class="add-tag-btn" onclick="addNewTag()">
                + Add Tag
              </button>
            </div>
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn btn-cancel"
              onclick="closeAddModal()"
            >
              Ï∑®ÏÜå
            </button>
            <button type="submit" class="btn btn-save">Ï†ÄÏû•</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let todos = [];
      let selectedTodoId = null;
      let tagCounter = 1;

      async function fetchTodos() {
        const response = await fetch("/todos");
        todos = await response.json();
        renderTodoList();
        updateTodoCount();
      }

      function updateTodoCount() {
        const count = todos.filter((t) => !t.completed).length;
        document.getElementById("todo-count").textContent = count;
      }

      function renderTodoList() {
        const todoList = document.getElementById("todo-list");
        todoList.innerHTML = "";

        if (todos.length === 0) {
          todoList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <p>ÏïÑÏßÅ Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.<br>ÏÉà ÏûëÏóÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî!</p>
            </div>
          `;
          return;
        }

        todos.forEach((todo) => {
          const li = document.createElement("li");
          li.className = `todo-item ${todo.completed ? "completed" : ""} ${
            selectedTodoId === todo.id ? "selected" : ""
          }`;
          li.onclick = () => selectTodo(todo.id);

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "todo-checkbox";
          checkbox.checked = todo.completed;
          checkbox.onclick = (e) => e.stopPropagation();
          checkbox.onchange = () => toggleTodo(todo.id);

          const contentDiv = document.createElement("div");
          contentDiv.className = "todo-item-content";

          const titleDiv = document.createElement("div");
          titleDiv.className = "todo-title";
          titleDiv.textContent = todo.title;

          const metaDiv = document.createElement("div");
          metaDiv.className = "todo-meta-info";

          if (todo.due_date) {
            const dueDateDiv = document.createElement("div");
            dueDateDiv.className = "todo-due-date-badge";
            dueDateDiv.innerHTML = `üìÖ ${todo.due_date}`;
            metaDiv.appendChild(dueDateDiv);
          }

          if (todo.subtasks && todo.subtasks.length > 0) {
            const subtasksDiv = document.createElement("div");
            subtasksDiv.className = "todo-subtasks-count";
            subtasksDiv.textContent = `${todo.subtasks.length} Subtasks`;
            metaDiv.appendChild(subtasksDiv);
          }

          if (todo.list) {
            const tagDiv = document.createElement("div");
            tagDiv.className = `todo-tag ${todo.list.toLowerCase()}`;
            tagDiv.textContent = todo.list;
            metaDiv.appendChild(tagDiv);
          }

          contentDiv.appendChild(titleDiv);
          contentDiv.appendChild(metaDiv);

          const arrowDiv = document.createElement("div");
          arrowDiv.className = "todo-arrow";
          arrowDiv.textContent = "‚Üí";

          li.appendChild(checkbox);
          li.appendChild(contentDiv);
          li.appendChild(arrowDiv);
          todoList.appendChild(li);
        });
      }

      function selectTodo(id) {
        selectedTodoId = id;
        const todo = todos.find((t) => t.id === id);
        if (todo) {
          renderRightPanel(todo);
          renderTodoList();
        }
      }

      function renderRightPanel(todo) {
        const rightPanel = document.getElementById("right-panel-content");
        rightPanel.innerHTML = `
          <div class="right-panel-header">
            <h2>Task:</h2>
            <div class="task-title">${todo.title}</div>
          </div>
          <div class="right-panel-content">
            <div class="form-section">
              <label>Description</label>
              <textarea id="edit-description">${todo.description || ""}</textarea>
            </div>
            <div class="form-row">
              <div class="form-section">
                <label>List</label>
                <select id="edit-list">
                  <option value="Personal" ${todo.list === "Personal" ? "selected" : ""}>Personal</option>
                  <option value="Work" ${todo.list === "Work" ? "selected" : ""}>Work</option>
                  <option value="List" ${todo.list === "List" ? "selected" : ""}>List</option>
                </select>
              </div>
              <div class="form-section">
                <label>Due date</label>
                <input type="date" id="edit-due-date" value="${todo.due_date || ""}" />
              </div>
            </div>
            <div class="form-section tags-section">
              <label>Tags</label>
              <div class="tags-container" id="edit-tags-container">
                ${renderTags(todo.tags || [])}
                <button type="button" class="add-tag-btn" onclick="addEditTag()">
                  + Add Tag
                </button>
              </div>
            </div>
            <div class="form-section subtasks-section">
              <label>Subtasks:</label>
              <div class="subtasks-list" id="subtasks-list">
                ${renderSubtasks(todo.subtasks || [])}
              </div>
              <button type="button" class="add-subtask-btn" onclick="addSubtask()">
                <span>+</span> Add New Subtask
              </button>
            </div>
          </div>
          <div class="right-panel-footer">
            <button class="btn-delete" onclick="deleteTodo(${todo.id})">
              Delete Task
            </button>
            <button class="btn-save" onclick="saveTodo(${todo.id})">
              Save changes
            </button>
          </div>
        `;
      }

      function renderTags(tags) {
        if (tags.length === 0) return "";
        return tags
          .map(
            (tag, index) => `
          <div class="tag">
            ${tag}
            <span onclick="removeTag(${index})" style="cursor: pointer;">√ó</span>
          </div>
        `
          )
          .join("");
      }

      function renderSubtasks(subtasks) {
        if (subtasks.length === 0) return "";
        return subtasks
          .map(
            (subtask, index) => `
          <div class="subtask-item">
            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? "checked" : ""} 
                   onchange="toggleSubtask(${index})" />
            <span class="subtask-text">${subtask.text}</span>
          </div>
        `
          )
          .join("");
      }

      function addNewTag() {
        const tagText = prompt("ÌÉúÍ∑∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
        if (tagText) {
          const container = document.getElementById("new-tags-container");
          const tagDiv = document.createElement("div");
          tagDiv.className = "tag";
          tagDiv.innerHTML = `${tagText} <span onclick="this.parentElement.remove()" style="cursor: pointer;">√ó</span>`;
          container.insertBefore(tagDiv, container.lastElementChild);
        }
      }

      function addEditTag() {
        const tagText = prompt("ÌÉúÍ∑∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
        if (tagText) {
          const container = document.getElementById("edit-tags-container");
          const tagDiv = document.createElement("div");
          tagDiv.className = "tag";
          tagDiv.innerHTML = `${tagText} <span onclick="this.parentElement.remove()" style="cursor: pointer;">√ó</span>`;
          container.insertBefore(tagDiv, container.lastElementChild);
        }
      }

      function removeTag(index) {
        const todo = todos.find((t) => t.id === selectedTodoId);
        if (todo && todo.tags) {
          todo.tags.splice(index, 1);
          renderRightPanel(todo);
        }
      }

      function addSubtask() {
        const todo = todos.find((t) => t.id === selectedTodoId);
        if (todo) {
          if (!todo.subtasks) todo.subtasks = [];
          const text = prompt("ÏÑúÎ∏åÌÉúÏä§ÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
          if (text) {
            todo.subtasks.push({ text, completed: false });
            renderRightPanel(todo);
          }
        }
      }

      function toggleSubtask(index) {
        const todo = todos.find((t) => t.id === selectedTodoId);
        if (todo && todo.subtasks) {
          todo.subtasks[index].completed = !todo.subtasks[index].completed;
        }
      }

      async function toggleTodo(id) {
        const todo = todos.find((t) => t.id === id);
        if (todo) {
          todo.completed = !todo.completed;
          await fetch(`/todos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(todo),
          });
          fetchTodos();
          if (selectedTodoId === id) {
            renderRightPanel(todo);
          }
        }
      }

      async function saveTodo(id) {
        const todo = todos.find((t) => t.id === id);
        if (!todo) return;

        todo.description = document.getElementById("edit-description").value;
        todo.list = document.getElementById("edit-list").value;
        todo.due_date = document.getElementById("edit-due-date").value || null;

        const tags = [];
        document
          .getElementById("edit-tags-container")
          .querySelectorAll(".tag")
          .forEach((tagEl) => {
            const text = tagEl.textContent.replace("√ó", "").trim();
            if (text) tags.push(text);
          });
        todo.tags = tags;

        const subtasks = [];
        document
          .getElementById("subtasks-list")
          .querySelectorAll(".subtask-item")
          .forEach((item) => {
            const checkbox = item.querySelector(".subtask-checkbox");
            const text = item.querySelector(".subtask-text").textContent;
            subtasks.push({
              text,
              completed: checkbox.checked,
            });
          });
        todo.subtasks = subtasks;

        await fetch(`/todos/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(todo),
        });

        fetchTodos();
        selectTodo(id);
      }

      async function deleteTodo(id) {
        if (!confirm("Ï†ïÎßê Ïù¥ ÏûëÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
          return;
        }

        await fetch(`/todos/${id}`, {
          method: "DELETE",
        });

        selectedTodoId = null;
        document.getElementById("right-panel-content").innerHTML = `
          <div class="empty-right-panel">
            ÏûëÏóÖÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉà ÏûëÏóÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
          </div>
        `;
        fetchTodos();
      }

      function openAddModal() {
        document.getElementById("add-modal").classList.add("active");
        document.getElementById("new-title").value = "";
        document.getElementById("new-description").value = "";
        document.getElementById("new-due-date").value = "";
        document.getElementById("new-tags-container").innerHTML =
          '<button type="button" class="add-tag-btn" onclick="addNewTag()">+ Add Tag</button>';
      }

      function closeAddModal() {
        document.getElementById("add-modal").classList.remove("active");
      }

      document
        .getElementById("add-task-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const title = document.getElementById("new-title").value;
          const description = document.getElementById("new-description").value;
          const list = document.getElementById("new-list").value;
          const due_date = document.getElementById("new-due-date").value || null;

          const tags = [];
          document
            .getElementById("new-tags-container")
            .querySelectorAll(".tag")
            .forEach((tagEl) => {
              const text = tagEl.textContent.replace("√ó", "").trim();
              if (text) tags.push(text);
            });

          const newTodo = {
            id: Date.now(),
            title,
            description,
            completed: false,
            due_date,
            list,
            tags,
            subtasks: [],
          };

          await fetch("/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(newTodo),
          });

          closeAddModal();
          fetchTodos();
          selectTodo(newTodo.id);
        });

      // Modal Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
      document.getElementById("add-modal").addEventListener("click", (e) => {
        if (e.target.id === "add-modal") {
          closeAddModal();
        }
      });

      fetchTodos();
    </script>
  </body>
</html>
